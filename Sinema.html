<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Günlüğüm</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter and Bebas Neue for the title -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-btn.active {
            background-color: #0891b2;
            color: white;
        }
        .tab-btn {
            transition: background-color 0.3s ease;
        }
        #backToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
        .cinema-title-container {
            border: 3px solid #FBBF24; /* amber-400 */
            padding: 0.5rem 1.5rem;
            display: inline-block;
            border-radius: 0.75rem;
            background: #111827; /* gray-900 */
            animation: flicker-border 3s linear infinite;
        }
        .cinema-title {
            font-family: 'Bebas Neue', cursive;
            color: #DC2626; /* red-600 */
            text-transform: uppercase;
            letter-spacing: 0.2rem;
            position: relative;
            -webkit-text-stroke: 1px #991B1B; /* red-800 for a darker edge */
            text-shadow: 2px 2px 2px #000;
        }
        .cinema-title::after {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            color: transparent;
            background-image: repeating-radial-gradient(circle at center, #FDE047 1px, transparent 2px);
            background-size: 8px 8px;
            -webkit-background-clip: text;
            background-clip: text;
            filter: drop-shadow(0 0 2px #FDE047);
            animation: flicker-text 1s linear infinite alternate;
        }
        @keyframes flicker-text {
            from {
                opacity: 1;
            }
            to {
                opacity: 0.7;
            }
        }
        @keyframes flicker-border {
            0%, 100% { box-shadow: 0 0 8px #F59E0B, 0 0 15px #F59E0B, inset 0 0 8px #FBBF24; }
            50% { box-shadow: 0 0 12px #FBBF24, 0 0 25px #FBBF24, inset 0 0 12px #FDE047; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 w-full h-full bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <p class="text-xl text-white">Yükleniyor...</p>
        </div>
    </div>

    <!-- Authentication Container (hidden by default) -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md">
            <div id="loginFormContainer">
                <form id="loginForm" class="bg-gray-800 p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Giriş Yap</h2>
                    <div class="mb-4">
                        <label for="loginEmail" class="block text-gray-400 mb-2">E-posta</label>
                        <input type="email" id="loginEmail" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="loginPassword" class="block text-gray-400 mb-2">Şifre</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Giriş Yap</button>
                    <p class="text-center text-gray-400 mt-6">
                        Hesabın yok mu? <a href="#" id="showRegister" class="text-cyan-400 hover:underline">Hesap Oluştur</a>
                    </p>
                </form>
            </div>
            <div id="registerFormContainer" class="hidden">
                <form id="registerForm" class="bg-gray-800 p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Hesap Oluştur</h2>
                    <div class="mb-4">
                        <label for="registerEmail" class="block text-gray-400 mb-2">E-posta</label>
                        <input type="email" id="registerEmail" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="registerPassword" class="block text-gray-400 mb-2">Şifre</label>
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Hesap Oluştur</button>
                    <p class="text-center text-gray-400 mt-6">
                        Zaten hesabın var mı? <a href="#" id="showLogin" class="text-cyan-400 hover:underline">Giriş Yap</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="appContainer" class="container mx-auto p-4 md:p-8 max-w-4xl mb-24 hidden">
        <header class="text-center mb-8">
            <div class="cinema-title-container">
                <h1 id="appTitle" class="text-5xl md:text-6xl cinema-title" data-text="Film Günlüğüm">Film Günlüğüm</h1>
            </div>
            <div class="mt-4 flex justify-center items-center gap-4">
                <div>
                    <p id="userEmailDisplay" class="text-gray-400"></p>
                    <h2 id="userNameDisplay" class="text-2xl text-gray-300 hidden"></h2>
                </div>
                <button id="settingsIconBtn" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Ayarlar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
            <button id="logoutBtn" class="mt-4 text-sm text-red-400 hover:underline">Çıkış Yap</button>
        </header>

        <div class="mb-8 border-b border-gray-700">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="mainTabBtn" class="tab-btn active font-medium px-4 py-2 text-gray-300 rounded-t-lg">Film Günlüğüm</button>
                <button id="collectionTabBtn" class="tab-btn font-medium px-4 py-2 text-gray-300 rounded-t-lg">Koleksiyonum</button>
                <button id="analysisTabBtn" class="tab-btn font-medium px-4 py-2 text-gray-300 rounded-t-lg">Analiz</button>
            </nav>
        </div>

        <main>
            <div id="mainContent">
                <div class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Yeni Film Ekle</h2>
                    <form id="searchForm" class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="searchInput" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 text-white" placeholder="Film, yönetmen veya oyuncu ara..." required>
                        <button type="submit" class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg">Ara</button>
                    </form>
                </div>
                <div id="searchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8"></div>
                <div id="search-loader" class="text-center hidden"><p>Aranıyor...</p></div>
                <div id="paginationControls" class="flex justify-center items-center gap-4 mt-8"></div>
                <div>
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 border-b-2 border-gray-700 pb-4 mt-8">
                        <div class="flex items-center gap-3">
                            <h2 class="text-3xl font-bold text-white">İzlediklerim</h2>
                            <span id="watchedCount" class="bg-cyan-600 text-white text-sm font-bold px-2.5 py-1 rounded-full">0</span>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <input type="text" id="filterInput" class="w-full md:w-2/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Listemde başlık, yönetmen veya oyuncu ara...">
                        <select id="genreFilter" class="w-full md:w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="">Tüm Türler</option>
                        </select>
                    </div>
                    <div id="watchedList" class="space-y-6"></div>
                    <div id="list-loader" class="text-center mt-8"><p>Listeniz yükleniyor...</p></div>
                    <p id="no-filter-results" class="text-center hidden mt-6">Arama kriterlerinize uygun film bulunamadı.</p>
                </div>
            </div>

            <div id="collectionContent" class="hidden">
                <div class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Koleksiyona DVD Ekle</h2>
                    <form id="dvdSearchForm" class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="dvdSearchInput" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Koleksiyon için film ara..." required>
                        <button type="submit" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">Ara</button>
                    </form>
                </div>
                <div id="dvdSearchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8"></div>
                <div id="dvd-search-loader" class="text-center hidden"><p>Aranıyor...</p></div>
                <div>
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 border-b-2 border-gray-700 pb-4 mt-8">
                        <h2 class="text-3xl font-bold text-white">DVD Koleksiyonum (<span id="dvdCount">0</span>)</h2>
                        <input type="text" id="dvdFilterInput" class="w-full md:w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Koleksiyonda ara...">
                    </div>
                    <div id="dvdListContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    </div>
                    <div id="dvd-list-loader" class="text-center mt-8 hidden"><p>Koleksiyon yükleniyor...</p></div>
                </div>
            </div>

            <div id="analysisContent" class="hidden">
                <h2 class="text-3xl font-bold text-white mb-6 border-b-2 border-gray-700 pb-4">İzleme Analizi</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-2xl font-semibold mb-4 text-cyan-400">Favori Yönetmenler</h3>
                        <ul id="directorAnalysis" class="space-y-2 text-gray-300"></ul>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold mb-4 text-cyan-400">Favori Oyuncular</h3>
                        <ul id="actorAnalysis" class="space-y-2 text-gray-300"></ul>
                    </div>
                </div>
            </div>

            <div id="settingsContent" class="hidden">
                <div id="settingsSection" class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Kullanıcı Bilgileri</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="firstNameInput" placeholder="Adınız" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="lastNameInput" placeholder="Soyadınız" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="saveSettingsBtn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Bilgileri Kaydet</button>
                </div>
                <div id="bulkAddSection" class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Toplu Film Ekle</h2>
                    <p class="text-gray-400 mb-4">Google Keep veya başka bir yerden kopyaladığınız film listenizi (her film yeni bir satırda olacak şekilde) aşağıdaki alana yapıştırın.</p>
                    <textarea id="bulkAddTextarea" class="w-full h-48 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Inception&#10;The Matrix - Yönetmen: Wachowskis&#10;Parasite..."></textarea>
                    <button id="bulkAddBtn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg">Listeyi İçe Aktar</button>
                    <div id="bulkAddStatus" class="mt-4 text-sm text-gray-400"></div>
                </div>
                <div id="dataManagementSection" class="p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Veri Yönetimi</h2>
                    <button id="exportBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg">Listeyi Dışa Aktar (CSV)</button>
                </div>
            </div>
        </main>
    </div>

    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"><p id="notification-message"></p></div>
    
    <button id="backToTopBtn" class="fixed bottom-5 right-5 bg-cyan-600 hover:bg-cyan-700 text-white p-3 rounded-full shadow-lg opacity-0 transform translate-y-16 transition-all duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    
    <div id="confirmModal" class="fixed inset-0 w-full h-full bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
            <h3 id="confirmModalTitle" class="text-xl font-semibold mb-4">Emin misiniz?</h3>
            <p id="confirmModalMessage" class="text-gray-300 mb-6">Bu öğeyi silmek istediğinizden emin misiniz?</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">İptal</button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Sil</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, setLogLevel, getDoc, setDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const TMDB_API_KEY = 'be3431f83282ebf814b6db565e75105d';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';

        const firebaseConfig = {
            apiKey: "AIzaSyAEgd5WVdDQxFFDUkTw7Kt1qqDbWQdmBo8",
            authDomain: "filmgunlugum-81fba.firebaseapp.com",
            projectId: "filmgunlugum-81fba",
            storageBucket: "filmgunlugum-81fba.appspot.com",
            messagingSenderId: "75259418247",
            appId: "1:75259418247:web:6bf046a8f913ebd1be4a22",
            measurementId: "G-4ZXXQ124RH"
        };
        
        const appId = firebaseConfig.projectId;
        
        let app, auth, db, userId;
        let watchedMoviesList = [];
        let dvdCollectionList = [];
        let unsubscribeSettings = () => {};
        let unsubscribeMovies = () => {};
        let unsubscribeDvds = () => {};
        let lastSearchQuery = '';
        let deleteAction = null;

        setLogLevel('debug');

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const loadingOverlay = document.getElementById('loadingOverlay');
            const authContainer = document.getElementById('authContainer');
            const appContainer = document.getElementById('appContainer');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const showRegister = document.getElementById('showRegister');
            const showLogin = document.getElementById('showLogin');
            const logoutBtn = document.getElementById('logoutBtn');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const mainTabBtn = document.getElementById('mainTabBtn');
            const collectionTabBtn = document.getElementById('collectionTabBtn');
            const analysisTabBtn = document.getElementById('analysisTabBtn');
            const settingsTabBtn = document.getElementById('settingsIconBtn'); // UPDATED
            const mainContent = document.getElementById('mainContent');
            const collectionContent = document.getElementById('collectionContent');
            const analysisContent = document.getElementById('analysisContent');
            const settingsContent = document.getElementById('settingsContent');
            const firstNameInput = document.getElementById('firstNameInput');
            const lastNameInput = document.getElementById('lastNameInput');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const watchedListContainer = document.getElementById('watchedList');
            const filterInput = document.getElementById('filterInput');
            const genreFilter = document.getElementById('genreFilter');
            const noFilterResults = document.getElementById('no-filter-results');
            const watchedCount = document.getElementById('watchedCount');
            const dvdSearchForm = document.getElementById('dvdSearchForm');
            const dvdSearchInput = document.getElementById('dvdSearchInput');
            const dvdSearchResultsContainer = document.getElementById('dvdSearchResults');
            const dvdListContainer = document.getElementById('dvdListContainer');
            const dvdCount = document.getElementById('dvdCount');
            const dvdFilterInput = document.getElementById('dvdFilterInput');
            const exportBtn = document.getElementById('exportBtn');
            const bulkAddTextarea = document.getElementById('bulkAddTextarea');
            const bulkAddBtn = document.getElementById('bulkAddBtn');
            const bulkAddStatus = document.getElementById('bulkAddStatus');
            const backToTopBtn = document.getElementById('backToTopBtn');
            const paginationControls = document.getElementById('paginationControls');
            const confirmModal = document.getElementById('confirmModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const directorAnalysisList = document.getElementById('directorAnalysis');
            const actorAnalysisList = document.getElementById('actorAnalysis');

            // --- APP INITIALIZATION ---
            (async () => {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    await setPersistence(auth, browserLocalPersistence);

                    onAuthStateChanged(auth, (user) => {
                        cleanupListeners();
                        if (user) {
                            userId = user.uid;
                            authContainer.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            userEmailDisplay.textContent = `Giriş yapıldı: ${user.email}`;
                            setupListeners();
                        } else {
                            userId = null;
                            authContainer.classList.remove('hidden');
                            appContainer.classList.add('hidden');
                            watchedListContainer.innerHTML = '';
                            dvdListContainer.innerHTML = '';
                        }
                        loadingOverlay.classList.add('hidden');
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    loadingOverlay.classList.add('hidden');
                    showNotification("Uygulama başlatılamadı. Lütfen tekrar deneyin.", true);
                }
            })();


            // --- AUTHENTICATION LOGIC ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = loginForm.loginEmail.value;
                const password = loginForm.loginPassword.value;
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => showNotification(getAuthErrorMessage(error.code), true));
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = registerForm.registerEmail.value;
                const password = registerForm.registerPassword.value;
                createUserWithEmailAndPassword(auth, email, password)
                    .catch(error => showNotification(getAuthErrorMessage(error.code), true));
            });

            logoutBtn.addEventListener('click', () => {
                signOut(auth);
            });

            showRegister.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginFormContainer').classList.add('hidden');
                document.getElementById('registerFormContainer').classList.remove('hidden');
            });

            showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginFormContainer').classList.remove('hidden');
                document.getElementById('registerFormContainer').classList.add('hidden');
            });
            
            // --- DATA LISTENERS ---
            function cleanupListeners() {
                if (typeof unsubscribeSettings === 'function') unsubscribeSettings();
                if (typeof unsubscribeMovies === 'function') unsubscribeMovies();
                if (typeof unsubscribeDvds === 'function') unsubscribeDvds();
            }
            
            function setupListeners() {
                if (!userId) return;

                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'profile');
                unsubscribeSettings = onSnapshot(settingsDocRef, (docSnap) => {
                    const settings = docSnap.exists() ? docSnap.data() : {};
                    if (document.activeElement !== firstNameInput) firstNameInput.value = settings.firstName || '';
                    if (document.activeElement !== lastNameInput) lastNameInput.value = settings.lastName || '';
                    const fullName = [settings.firstName, settings.lastName].filter(Boolean).join(' ');
                    userNameDisplay.textContent = fullName;
                    userNameDisplay.classList.toggle('hidden', !fullName);
                });
                
                const listLoader = document.getElementById('list-loader');
                listLoader.classList.remove('hidden');
                const moviesCollectionPath = collection(db, 'artifacts', appId, 'users', userId, 'movies');
                unsubscribeMovies = onSnapshot(query(moviesCollectionPath), (snapshot) => {
                    listLoader.classList.add('hidden');
                    watchedMoviesList = [];
                    snapshot.forEach(doc => watchedMoviesList.push({ id: doc.id, ...doc.data() }));
                    watchedMoviesList.sort((a, b) => a.title.localeCompare(b.title));
                    watchedCount.textContent = watchedMoviesList.length;
                    populateGenreFilter();
                    filterAndDisplayWatchedMovies();
                    generateAnalysis();
                    if(snapshot.empty) { watchedListContainer.innerHTML = `<div class="text-center py-10 px-6 bg-gray-800 rounded-lg"><p>Henüz izlediğiniz bir film eklemediniz.</p></div>`; }
                }, (error) => { console.error("Error listening to movie collection:", error); });

                const dvdListLoader = document.getElementById('dvd-list-loader');
                dvdListLoader.classList.remove('hidden');
                const dvdCollectionPath = collection(db, 'artifacts', appId, 'users', userId, 'dvd_collection');
                unsubscribeDvds = onSnapshot(query(dvdCollectionPath), (snapshot) => {
                    dvdListLoader.classList.add('hidden');
                    dvdCollectionList = [];
                    snapshot.forEach(doc => dvdCollectionList.push({ id: doc.id, ...doc.data() }));
                    dvdCount.textContent = dvdCollectionList.length;
                    filterAndDisplayDvds();
                    if(snapshot.empty) { dvdListContainer.innerHTML = `<p class="col-span-full text-center text-gray-400">Henüz koleksiyonunuza bir DVD eklemediniz.</p>`; }
                });
            }


            // --- TAB NAVIGATION LOGIC ---
            function showMainTab() {
                mainContent.classList.remove('hidden');
                collectionContent.classList.add('hidden');
                analysisContent.classList.add('hidden');
                settingsContent.classList.add('hidden');
                mainTabBtn.classList.add('active');
                collectionTabBtn.classList.remove('active');
                analysisTabBtn.classList.remove('active');
            }

            function showCollectionTab() {
                mainContent.classList.add('hidden');
                collectionContent.classList.remove('hidden');
                analysisContent.classList.add('hidden');
                settingsContent.classList.add('hidden');
                mainTabBtn.classList.remove('active');
                collectionTabBtn.classList.add('active');
                analysisTabBtn.classList.remove('active');
            }

            function showAnalysisTab() {
                mainContent.classList.add('hidden');
                collectionContent.classList.add('hidden');
                analysisContent.classList.remove('hidden');
                settingsContent.classList.add('hidden');
                mainTabBtn.classList.remove('active');
                collectionTabBtn.classList.remove('active');
                analysisTabBtn.classList.add('active');
            }

            function showSettingsTab() {
                mainContent.classList.add('hidden');
                collectionContent.classList.add('hidden');
                analysisContent.classList.add('hidden');
                settingsContent.classList.remove('hidden');
                mainTabBtn.classList.remove('active');
                collectionTabBtn.classList.remove('active');
                analysisTabBtn.classList.remove('active');
            }

            // --- USER SETTINGS FUNCTIONS ---
            async function saveUserSettings() {
                if (!userId) return;
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'profile');
                const settingsData = { firstName: firstNameInput.value.trim(), lastName: lastNameInput.value.trim() };
                try {
                    await setDoc(settingsDocRef, settingsData, { merge: true });
                    showNotification("Kullanıcı bilgileri kaydedildi!", false);
                } catch (error) {
                    showNotification("Ayarlar kaydedilirken hata oluştu.", true);
                }
            }
            
            // --- TMDB API & FIRESTORE FUNCTIONS ---
            async function performMultiSearch(query, page = 1) {
                if (!TMDB_API_KEY) { showNotification("TMDb API anahtarı eksik.", true); return null; }
                const searchLoader = document.getElementById('search-loader');
                searchResultsContainer.innerHTML = '';
                paginationControls.innerHTML = '';
                searchLoader.classList.remove('hidden');
                const url = `${TMDB_BASE_URL}/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&language=tr-TR&include_adult=false&page=${page}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) return null;
                    return await response.json();
                } catch (error) { console.error('Error fetching multi-search:', error); return null; } 
                finally { searchLoader.classList.add('hidden'); }
            }

            function displayMultiSearchResults(data) {
                const results = data.results;
                searchResultsContainer.innerHTML = '';
                if (!results || results.length === 0) {
                    searchResultsContainer.innerHTML = `<p class="col-span-full text-center">Sonuç bulunamadı.</p>`;
                    return;
                }
                results.forEach(result => {
                    if (result.media_type === 'movie') {
                        const posterPath = result.poster_path ? `https://image.tmdb.org/t/p/w500${result.poster_path}` : 'https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';
                        const releaseYear = result.release_date ? result.release_date.split('-')[0] : 'N/A';
                        const movieCard = `<div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg movie-card flex flex-col"><div class="w-full h-48 bg-gray-700 flex items-center justify-center"><img src="${posterPath}" alt="${result.title}" class="w-full h-full object-contain" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';"></div><div class="p-3 flex flex-col flex-grow"><h3 class="font-bold text-sm text-white">${result.title}</h3><p class="text-gray-400 text-xs mb-2">${releaseYear}</p><button class="add-movie-btn mt-auto w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-2 text-sm rounded-lg" data-tmdb-id="${result.id}" data-title="${encodeURIComponent(result.title)}" data-poster-path="${result.poster_path || ''}" data-release-year="${releaseYear}">Ekle</button></div></div>`;
                        searchResultsContainer.innerHTML += movieCard;
                    } else if (result.media_type === 'person') {
                        const profilePath = result.profile_path ? `https://image.tmdb.org/t/p/w500${result.profile_path}` : 'https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';
                        const personCard = `<div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg movie-card flex flex-col"><div class="w-full h-48 bg-gray-700 flex items-center justify-center"><img src="${profilePath}" alt="${result.name}" class="w-full h-full object-contain" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';"></div><div class="p-3 flex flex-col flex-grow"><h3 class="font-bold text-sm text-white">${result.name}</h3><p class="text-gray-400 text-xs mb-2">${result.known_for_department}</p><button class="show-person-movies-btn mt-auto w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1 px-2 text-sm rounded-lg" data-person-id="${result.id}">Filmlerini Göster</button></div></div>`;
                        searchResultsContainer.innerHTML += personCard;
                    }
                });
                renderPaginationControls(data.page, data.total_pages);
            }
            
            async function getPersonMovieCredits(personId) {
                if (!TMDB_API_KEY) return null;
                const url = `${TMDB_BASE_URL}/person/${personId}/movie_credits?api_key=${TMDB_API_KEY}&language=tr-TR`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) return null;
                    const data = await response.json();
                    const allMovies = [...data.cast, ...data.crew].map(m => ({ ...m, media_type: 'movie' }));
                    const uniqueMovies = Array.from(new Map(allMovies.map(movie => [movie.id, movie])).values());
                    return uniqueMovies.sort((a, b) => b.popularity - a.popularity);
                } catch (error) {
                    console.error('Error fetching person credits:', error);
                    return null;
                }
            }
            
            async function getMovieDetails(tmdbId) {
                if (!TMDB_API_KEY) return null;
                const url = `${TMDB_BASE_URL}/movie/${tmdbId}?api_key=${TMDB_API_KEY}&language=tr-TR&append_to_response=watch/providers,credits`;
                try { const response = await fetch(url); return await response.json(); } catch (error) { return null; }
            }

            function displayWatchedMovie(movie) {
                const posterPath = movie.posterPath ? `https://image.tmdb.org/t/p/w500${movie.posterPath}` : 'https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';
                const movieElement = document.createElement('div');
                movieElement.className = 'movie-card bg-gray-800 rounded-lg shadow-xl overflow-hidden flex flex-col md:flex-row';
                const genreTags = movie.genres && movie.genres.length > 0 ? movie.genres.map(genre => `<span class="bg-purple-600 text-white text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${genre}</span>`).join('') : `<span class="bg-gray-600 text-gray-200 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Film</span>`;
                
                let ratingHtml = '';
                if (movie.voteAverage) {
                    ratingHtml = `<div class="flex items-center gap-1 text-yellow-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg><span class="font-bold">${movie.voteAverage.toFixed(1)}</span></div>`;
                }

                let directorHtml = '';
                if (movie.director) {
                    directorHtml = `<div class="mt-2"><p class="text-xs text-gray-400">Yönetmen: <span class="text-gray-300">${movie.director}</span></p></div>`;
                }

                let castHtml = '';
                if (movie.cast && movie.cast.length > 0) {
                    castHtml = `<div class="mt-1"><p class="text-xs text-gray-400">Oyuncular: <span class="text-gray-300">${movie.cast.join(', ')}</span></p></div>`;
                }

                let providersHtml = '';
                if (movie.watchProviders && movie.watchProviders.length > 0) {
                    const providerLogos = movie.watchProviders.map(p => `<img src="https://image.tmdb.org/t/p/w45${p.logo_path}" alt="${p.provider_name}" title="${p.provider_name}" class="w-8 h-8 rounded-md">`).join('');
                    providersHtml = `<div class="mt-4"><p class="text-xs text-gray-400 mb-1">Platformlar (TR):</p><div class="flex flex-wrap gap-2">${providerLogos}</div></div>`;
                }
                movieElement.innerHTML = `<div class="w-full md:w-48 bg-gray-700 flex-shrink-0 flex items-center justify-center"><img src="${posterPath}" alt="${movie.title}" class="w-full h-full object-contain" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';"></div><div class="p-6 flex flex-col flex-grow"><div class="flex-shrink-0"><div class="flex justify-between items-start"><h3 class="text-2xl font-bold text-white pr-2">${movie.title}</h3>${ratingHtml}</div><div class="flex items-center flex-wrap gap-y-2 my-2">${genreTags}</div><p class="text-gray-400 mb-2">${movie.releaseYear}</p>${directorHtml}${castHtml}${providersHtml}</div><textarea class="notes-textarea w-full h-24 p-3 mt-4 bg-gray-700 border border-gray-600 rounded-lg" data-doc-id="${movie.id}" placeholder="Bu filmle ilgili notların...">${movie.notes || ''}</textarea><div class="mt-auto pt-4 flex flex-col sm:flex-row gap-3"><button class="save-notes-btn w-full sm:w-auto flex-grow bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg" data-doc-id="${movie.id}">Notları Kaydet</button><button class="delete-movie-btn w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg" data-doc-id="${movie.id}">Filmi Sil</button><button class="update-movie-btn p-2 bg-gray-600 hover:bg-gray-700 rounded-lg" title="Bilgileri Yenile" data-doc-id="${movie.id}" data-tmdb-id="${movie.tmdbId}"><svg class="w-5 h-5 text-white pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.693L7.985 5.959m0 0a8.25 8.25 0 0111.664 0l3.181 3.183" /></svg></button></div></div>`;
                watchedListContainer.appendChild(movieElement);
            }

            async function addMovieToFirestore(movieData) {
                if (!userId) return { status: 'error' };
                const moviesCollection = collection(db, 'artifacts', appId, 'users', userId, 'movies');
                const q = query(moviesCollection, where("tmdbId", "==", movieData.tmdbId));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) { return { status: 'duplicate' }; }
                
                const details = await getMovieDetails(movieData.tmdbId);
                if (details) {
                    movieData.genres = details.genres ? details.genres.map(g => g.name) : [];
                    movieData.voteAverage = details.vote_average || 0;
                    
                    if (details.credits) {
                        const director = details.credits.crew.find(person => person.job === 'Director');
                        movieData.director = director ? director.name : '';
                        movieData.cast = details.credits.cast.slice(0, 3).map(actor => actor.name);
                    }

                    let providers = [];
                    if (details['watch/providers']?.results?.TR?.flatrate) {
                        providers = details['watch/providers'].results.TR.flatrate.map(p => ({ 
                            provider_id: p.provider_id, 
                            provider_name: p.provider_name, 
                            logo_path: p.logo_path 
                        }));
                    }
                    movieData.watchProviders = providers;
                }

                try { 
                    await addDoc(moviesCollection, movieData); 
                    return { status: 'success' };
                } catch (error) { 
                    console.error("Error adding document: ", error);
                    return { status: 'error' };
                }
            }
            
            function displayDvd(dvd) {
                const posterPath = dvd.posterPath ? `https://image.tmdb.org/t/p/w500${dvd.posterPath}` : 'https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';
                const dvdElement = document.createElement('div');
                dvdElement.className = 'relative group';
                dvdElement.innerHTML = `
                    <img src="${posterPath}" alt="${dvd.title}" class="w-full h-full object-cover rounded-lg shadow-lg" loading="lazy">
                    <div class="absolute inset-0 bg-black bg-opacity-75 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center p-2 rounded-lg">
                        <p class="text-white text-center font-bold text-sm">${dvd.title}</p>
                        <button class="delete-dvd-btn mt-2 bg-red-600 text-white p-2 rounded-full" data-doc-id="${dvd.id}" title="Koleksiyondan Sil">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                dvdListContainer.appendChild(dvdElement);
            }

            async function addDvdToFirestore(dvdData) {
                if (!userId) return { status: 'error' };
                const dvdCollection = collection(db, 'artifacts', appId, 'users', userId, 'dvd_collection');
                const q = query(dvdCollection, where("tmdbId", "==", dvdData.tmdbId));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) { return { status: 'duplicate' }; }
                
                const dataToSave = {
                    title: decodeURIComponent(dvdData.title),
                    posterPath: dvdData.posterPath,
                    tmdbId: dvdData.tmdbId,
                    addedAt: new Date()
                };

                try { 
                    await addDoc(dvdCollection, dataToSave); 
                    return { status: 'success' };
                } catch (error) { 
                    console.error("Error adding DVD: ", error);
                    return { status: 'error' };
                }
            }

            async function deleteDvdFromFirestore(docId) {
                if (!userId) return;
                try {
                    const dvdDocRef = doc(db, 'artifacts', appId, 'users', userId, 'dvd_collection', docId);
                    await deleteDoc(dvdDocRef);
                    showNotification("DVD koleksiyondan silindi.", false);
                } catch(error) {
                    console.error("Error deleting DVD:", error);
                    showNotification("DVD silinirken bir hata oluştu.", true);
                }
            }

            async function handleUpdateMovieDetails(docId, tmdbId) {
                if (!userId) return;
                showNotification("Film bilgileri güncelleniyor...", false);
                const details = await getMovieDetails(tmdbId);
                if (!details) {
                    showNotification("Detaylar alınamadı.", true);
                    return;
                }

                const movieDocRef = doc(db, 'artifacts', appId, 'users', userId, 'movies', docId);
                const updateData = {};
                
                updateData.genres = details.genres ? details.genres.map(g => g.name) : [];
                updateData.voteAverage = details.vote_average || 0;
                
                if (details.credits) {
                    const director = details.credits.crew.find(person => person.job === 'Director');
                    updateData.director = director ? director.name : '';
                    updateData.cast = details.credits.cast.slice(0, 3).map(actor => actor.name);
                }

                let providers = [];
                if (details['watch/providers']?.results?.TR?.flatrate) {
                    providers = details['watch/providers'].results.TR.flatrate.map(p => ({ 
                        provider_id: p.provider_id, 
                        provider_name: p.provider_name, 
                        logo_path: p.logo_path 
                    }));
                }
                updateData.watchProviders = providers;

                try {
                    await updateDoc(movieDocRef, updateData);
                    showNotification("Film bilgileri güncellendi!", false);
                } catch (error) {
                    console.error("Error updating movie details:", error);
                    showNotification("Güncelleme sırasında bir hata oluştu.", true);
                }
            }

            async function updateNotesInFirestore(docId, notes) {
                if (!userId) return;
                try { await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'movies', docId), { notes: notes }); showNotification("Notlar kaydedildi!", false); } catch (error) { console.error("Error updating notes: ", error); }
            }

            async function deleteMovieFromFirestore(docId) {
                if (!userId) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'movies', docId));
                    showNotification("Film başarıyla silindi.", false);
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showNotification("Film silinirken bir hata oluştu.", true);
                }
            }
            
            function populateGenreFilter() {
                const allGenres = new Set();
                watchedMoviesList.forEach(movie => { if(movie.genres) movie.genres.forEach(genre => allGenres.add(genre)); });
                genreFilter.innerHTML = '<option value="">Tüm Türler</option>';
                Array.from(allGenres).sort().forEach(genre => { const option = document.createElement('option'); option.value = genre; option.textContent = genre; genreFilter.appendChild(option); });
            }

            function filterAndDisplayWatchedMovies() {
                const filterText = filterInput.value.toLocaleLowerCase('tr-TR');
                const selectedGenre = genreFilter.value;
                const filteredMovies = watchedMoviesList.filter(movie => {
                    const titleMatch = movie.title.toLocaleLowerCase('tr-TR').includes(filterText);
                    const directorMatch = movie.director ? movie.director.toLocaleLowerCase('tr-TR').includes(filterText) : false;
                    const castMatch = movie.cast ? movie.cast.some(actor => actor.toLocaleLowerCase('tr-TR').includes(filterText)) : false;
                    const genreMatch = !selectedGenre || (movie.genres && movie.genres.includes(selectedGenre));
                    return (titleMatch || directorMatch || castMatch) && genreMatch;
                });
                watchedListContainer.innerHTML = '';
                if (filteredMovies.length > 0) { filteredMovies.forEach(displayWatchedMovie); }
                noFilterResults.style.display = filteredMovies.length === 0 && watchedMoviesList.length > 0 ? 'block' : 'none';
            }
            
            function filterAndDisplayDvds() {
                const filterText = dvdFilterInput.value.toLocaleLowerCase('tr-TR');
                const filteredDvds = dvdCollectionList.filter(dvd => {
                    return dvd.title.toLocaleLowerCase('tr-TR').includes(filterText);
                });
                dvdListContainer.innerHTML = '';
                if (filteredDvds.length > 0) {
                    filteredDvds.forEach(displayDvd);
                } else {
                    if (dvdCollectionList.length > 0) {
                         dvdListContainer.innerHTML = `<p class="col-span-full text-center text-gray-400">Arama kriterlerinize uygun DVD bulunamadı.</p>`;
                    } else {
                         dvdListContainer.innerHTML = `<p class="col-span-full text-center text-gray-400">Henüz koleksiyonunuza bir DVD eklemediniz.</p>`;
                    }
                }
            }
            
            function exportToCSV() {
                if (watchedMoviesList.length === 0) { showNotification("Dışa aktarılacak film yok.", true); return; }
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += ["Başlık", "Yıl", "Türler", "Notlar"].join(",") + "\r\n";
                watchedMoviesList.forEach(movie => {
                    const row = [`"${movie.title.replace(/"/g, '""')}"`, movie.releaseYear, `"${movie.genres ? movie.genres.join(', ') : ''}"`, `"${movie.notes ? movie.notes.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`].join(",");
                    csvContent += row + "\r\n";
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "film_gunlugum.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            async function handleBulkAdd() {
                const text = bulkAddTextarea.value.trim();
                if (!text) { showNotification("Lütfen eklenecek film listesini girin.", true); return; }
                const movieTitles = text.split('\n').map(line => line.split('-')[0].trim()).filter(title => title.length > 0);
                if (movieTitles.length === 0) return;
                bulkAddBtn.disabled = true;
                bulkAddBtn.textContent = "İşleniyor...";
                bulkAddStatus.innerHTML = '';
                let addedCount = 0, duplicateCount = 0, notFoundCount = 0;
                for (let i = 0; i < movieTitles.length; i++) {
                    const title = movieTitles[i];
                    bulkAddStatus.innerHTML = `<p>${i + 1}/${movieTitles.length} işleniyor: <strong>${title}</strong></p>`;
                    const searchData = await performMultiSearch(title);
                    if (searchData && searchData.results.length > 0) {
                        const movie = searchData.results.find(r => r.media_type === 'movie');
                        if (movie) {
                            const movieData = { tmdbId: movie.id.toString(), title: movie.title, posterPath: movie.poster_path || '', releaseYear: movie.release_date ? movie.release_date.split('-')[0] : 'N/A', notes: '' };
                            const result = await addMovieToFirestore(movieData);
                            if (result.status === 'success') {
                                addedCount++;
                            } else if (result.status === 'duplicate') {
                                duplicateCount++;
                            }
                        } else {
                            notFoundCount++;
                        }
                    } else {
                        notFoundCount++;
                    }
                    await new Promise(resolve => setTimeout(resolve, 250));
                }
                bulkAddStatus.innerHTML = `<p class="font-bold text-white">İşlem Tamamlandı!</p><p class="text-green-400">${addedCount} film eklendi.</p><p class="text-yellow-400">${duplicateCount} film zaten listede vardı.</p><p class="text-red-400">${notFoundCount} film bulunamadı.</p>`;
                bulkAddBtn.disabled = false;
                bulkAddBtn.textContent = "Listeyi İçe Aktar";
                bulkAddTextarea.value = '';
            }
            
            function renderPaginationControls(page, totalPages) {
                paginationControls.innerHTML = '';
                if (totalPages <= 1) return;

                const prevButton = document.createElement('button');
                prevButton.textContent = 'Önceki';
                prevButton.className = 'px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed';
                prevButton.disabled = page === 1;
                prevButton.addEventListener('click', () => {
                    performMultiSearch(lastSearchQuery, page - 1).then(data => displayMultiSearchResults(data));
                });

                const pageInfo = document.createElement('span');
                pageInfo.textContent = `Sayfa ${page} / ${totalPages}`;
                pageInfo.className = 'px-4';
                
                const nextButton = document.createElement('button');
                nextButton.textContent = 'Sonraki';
                nextButton.className = 'px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed';
                nextButton.disabled = page >= totalPages;
                nextButton.addEventListener('click', () => {
                    performMultiSearch(lastSearchQuery, page + 1).then(data => displayMultiSearchResults(data));
                });

                paginationControls.appendChild(prevButton);
                paginationControls.appendChild(pageInfo);
                paginationControls.appendChild(nextButton);
            }
            
            function displayDvdSearchResults(results) {
                dvdSearchResultsContainer.innerHTML = '';
                if (!results || results.length === 0) {
                    dvdSearchResultsContainer.innerHTML = `<p class="col-span-full text-center">Sonuç bulunamadı.</p>`;
                    return;
                }
                results.filter(r => r.media_type === 'movie').slice(0, 12).forEach(movie => {
                    const posterPath = movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : 'https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';
                    const releaseYear = movie.release_date ? movie.release_date.split('-')[0] : 'N/A';
                    const movieCard = `<div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg movie-card flex flex-col"><div class="w-full h-48 bg-gray-700 flex items-center justify-center"><img src="${posterPath}" alt="${movie.title}" class="w-full h-full object-contain" loading="lazy"></div><div class="p-3 flex flex-col flex-grow"><h3 class="font-bold text-sm text-white">${movie.title}</h3><p class="text-gray-400 text-xs mb-2">${releaseYear}</p><button class="add-dvd-btn mt-auto w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-2 text-sm rounded-lg" data-tmdb-id="${movie.id}" data-title="${encodeURIComponent(movie.title)}" data-poster-path="${movie.poster_path || ''}">Koleksiyona Ekle</button></div></div>`;
                    dvdSearchResultsContainer.innerHTML += movieCard;
                });
            }
            
            function generateAnalysis() {
                const directorCounts = {};
                const actorCounts = {};

                watchedMoviesList.forEach(movie => {
                    if (movie.director) {
                        directorCounts[movie.director] = (directorCounts[movie.director] || 0) + 1;
                    }
                    if (movie.cast) {
                        movie.cast.forEach(actor => {
                            actorCounts[actor] = (actorCounts[actor] || 0) + 1;
                        });
                    }
                });

                renderAnalysisList(directorAnalysisList, directorCounts, 'film');
                renderAnalysisList(actorAnalysisList, actorCounts, 'film');
            }

            function renderAnalysisList(element, data, unit) {
                element.innerHTML = '';
                const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a);
                sortedData.slice(0, 10).forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-gray-800 p-2 rounded";
                    li.innerHTML = `<button class="text-left hover:text-cyan-400 analysis-item" data-name="${name}">${name}</button><span class="font-bold text-cyan-400">${count} ${unit}</span>`;
                    element.appendChild(li);
                });
            }

            // --- EVENT LISTENERS ---
            mainTabBtn.addEventListener('click', showMainTab);
            settingsTabBtn.addEventListener('click', showSettingsTab);
            collectionTabBtn.addEventListener('click', showCollectionTab);
            analysisTabBtn.addEventListener('click', showAnalysisTab);
            saveSettingsBtn.addEventListener('click', saveUserSettings);
            searchForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const term = searchInput.value.trim(); 
                if (term) {
                    lastSearchQuery = term;
                    const data = await performMultiSearch(term, 1);
                    displayMultiSearchResults(data);
                }
            });
            dvdSearchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const term = dvdSearchInput.value.trim();
                if (term) {
                    const data = await performMultiSearch(term);
                    displayDvdSearchResults(data ? data.results : []);
                }
            });
            filterInput.addEventListener('input', filterAndDisplayWatchedMovies);
            dvdFilterInput.addEventListener('input', filterAndDisplayDvds);
            genreFilter.addEventListener('change', filterAndDisplayWatchedMovies);
            exportBtn.addEventListener('click', exportToCSV);
            bulkAddBtn.addEventListener('click', handleBulkAdd);
            backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.remove('opacity-0', 'translate-y-16');
                } else {
                    backToTopBtn.classList.add('opacity-0', 'translate-y-16');
                }
            });

            confirmDeleteBtn.addEventListener('click', () => {
                if (typeof deleteAction === 'function') {
                    deleteAction();
                }
                confirmModal.classList.add('hidden');
                deleteAction = null;
            });

            cancelDeleteBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                deleteAction = null;
            });

            document.addEventListener('click', async (e) => {
                const addBtn = e.target.closest('.add-movie-btn');
                const saveNotesBtn = e.target.closest('.save-notes-btn');
                const deleteBtn = e.target.closest('.delete-movie-btn');
                const updateBtn = e.target.closest('.update-movie-btn');
                const personBtn = e.target.closest('.show-person-movies-btn');
                const addDvdBtn = e.target.closest('.add-dvd-btn');
                const deleteDvdBtn = e.target.closest('.delete-dvd-btn');
                const analysisItem = e.target.closest('.analysis-item');

                if (addBtn) {
                    addBtn.disabled = true;
                    addBtn.textContent = 'Ekleniyor...';
                    const movieData = { tmdbId: addBtn.dataset.tmdbId, title: decodeURIComponent(addBtn.dataset.title), posterPath: addBtn.dataset.posterPath, releaseYear: addBtn.dataset.releaseYear, notes: '' };
                    try {
                        const result = await addMovieToFirestore(movieData);
                        if (result.status === 'success') {
                            showNotification(`"${movieData.title}" eklendi!`, false);
                        } else if (result.status === 'duplicate') {
                            showNotification(`"${movieData.title}" zaten listenizde!`, true);
                        } else {
                             showNotification('Film eklenirken bir hata oluştu.', true);
                        }
                    } catch (error) {
                        console.error("Add movie button error:", error);
                        showNotification('Beklenmedik bir hata oluştu.', true);
                    } finally {
                        searchResultsContainer.innerHTML = '';
                        searchInput.value = '';
                        paginationControls.innerHTML = '';
                    }
                }
                if (addDvdBtn) {
                    addDvdBtn.disabled = true;
                    addDvdBtn.textContent = 'Ekleniyor...';
                    const dvdData = {
                        tmdbId: addDvdBtn.dataset.tmdbId,
                        title: decodeURIComponent(addDvdBtn.dataset.title),
                        posterPath: addDvdBtn.dataset.posterPath
                    };
                    try {
                        const result = await addDvdToFirestore(dvdData);
                        if (result.status === 'success') {
                            showNotification(`"${dvdData.title}" koleksiyona eklendi!`, false);
                        } else if (result.status === 'duplicate') {
                            showNotification(`"${dvdData.title}" zaten koleksiyonda!`, true);
                        } else {
                            showNotification('DVD eklenirken bir hata oluştu.', true);
                        }
                    } catch (error) {
                        console.error("Add DVD button error:", error);
                        showNotification('Beklenmedik bir hata oluştu.', true);
                    } finally {
                        dvdSearchResultsContainer.innerHTML = '';
                        dvdSearchInput.value = '';
                    }
                }
                if (saveNotesBtn) {
                    const docId = saveNotesBtn.dataset.docId;
                    const notesTextarea = document.querySelector(`.notes-textarea[data-doc-id='${docId}']`);
                    if (notesTextarea) updateNotesInFirestore(docId, notesTextarea.value);
                }
                if (deleteBtn) {
                    deleteAction = () => deleteMovieFromFirestore(deleteBtn.dataset.docId);
                    confirmModal.classList.remove('hidden');
                }
                if (updateBtn) {
                    handleUpdateMovieDetails(updateBtn.dataset.docId, updateBtn.dataset.tmdbId);
                }
                if(personBtn) {
                    const personId = personBtn.dataset.personId;
                    const movies = await getPersonMovieCredits(personId);
                    displayMultiSearchResults({results: movies, page: 1, total_pages: 1});
                }
                if (deleteDvdBtn) {
                    deleteAction = () => deleteDvdFromFirestore(deleteDvdBtn.dataset.docId);
                    confirmModal.classList.remove('hidden');
                }
                if (analysisItem) {
                    const name = analysisItem.dataset.name;
                    showMainTab();
                    filterInput.value = name;
                    filterInput.dispatchEvent(new Event('input', { bubbles: true }));
                    filterInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });

            function showNotification(message, isError = false) {
                const notification = document.getElementById('notification');
                const messageElement = document.getElementById('notification-message');
                messageElement.textContent = message;
                notification.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                notification.classList.remove('opacity-0');
                setTimeout(() => notification.classList.add('opacity-0'), 3000);
            }

            function getAuthErrorMessage(code) {
                switch (code) {
                    case 'auth/wrong-password':
                        return 'Yanlış şifre. Lütfen tekrar deneyin.';
                    case 'auth/user-not-found':
                        return 'Bu e-posta ile kayıtlı bir kullanıcı bulunamadı.';
                    case 'auth/email-already-in-use':
                        return 'Bu e-posta adresi zaten kullanılıyor.';
                    case 'auth/weak-password':
                        return 'Şifre çok zayıf. En az 6 karakter olmalı.';
                    case 'auth/invalid-email':
                        return 'Geçersiz e-posta adresi.';
                    case 'auth/operation-not-allowed':
                        return 'E-posta/Şifre ile giriş yöntemi Firebase projenizde aktif değil.';
                    default:
                        return `Bir kimlik doğrulama hatası oluştu: ${code}`;
                }
            }

        });
    </script>
</body>
</html>
