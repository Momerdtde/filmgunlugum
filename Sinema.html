<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Günlüğüm</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter and Bebas Neue for the title -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-btn.active {
            background-color: #0891b2; /* cyan-600 */
            color: white;
            border-bottom-color: transparent;
        }
        .tab-btn {
            transition: background-color 0.3s ease, color 0.3s ease;
             border-bottom: 2px solid transparent;
        }
        #backToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
        .cinema-title-container {
            border: 3px solid #FBBF24; /* amber-400 */
            padding: 0.5rem 1.5rem;
            display: inline-block;
            border-radius: 0.75rem;
            background: #111827; /* gray-900 */
            animation: flicker-border 3s linear infinite;
        }
        .cinema-title {
            font-family: 'Bebas Neue', cursive;
            color: #DC2626; /* red-600 */
            text-transform: uppercase;
            letter-spacing: 0.2rem;
            position: relative;
            -webkit-text-stroke: 1px #991B1B; /* red-800 for a darker edge */
            text-shadow: 2px 2px 2px #000;
        }
        .cinema-title::after {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            color: transparent;
            background-image: repeating-radial-gradient(circle at center, #FDE047 1px, transparent 2px);
            background-size: 8px 8px;
            -webkit-background-clip: text;
            background-clip: text;
            filter: drop-shadow(0 0 2px #FDE047);
            animation: flicker-text 1s linear infinite alternate;
        }
        @keyframes flicker-text {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
        @keyframes flicker-border {
            0%, 100% { box-shadow: 0 0 8px #F59E0B, 0 0 15px #F59E0B, inset 0 0 8px #FBBF24; }
            50% { box-shadow: 0 0 12px #FBBF24, 0 0 25px #FBBF24, inset 0 0 12px #FDE047; }
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 w-full h-full bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <p class="text-xl text-white">Yükleniyor...</p>
        </div>
    </div>

    <!-- Authentication Container (hidden by default) -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md">
            <div id="loginFormContainer">
                <form id="loginForm" class="bg-gray-800 p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Giriş Yap</h2>
                    <div class="mb-4">
                        <label for="loginEmail" class="block text-gray-400 mb-2">E-posta</label>
                        <input type="email" id="loginEmail" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="loginPassword" class="block text-gray-400 mb-2">Şifre</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Giriş Yap</button>
                    <p class="text-center text-gray-400 mt-6">
                        Hesabın yok mu? <a href="#" id="showRegister" class="text-cyan-400 hover:underline">Hesap Oluştur</a>
                    </p>
                </form>
            </div>
            <div id="registerFormContainer" class="hidden">
                <form id="registerForm" class="bg-gray-800 p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Hesap Oluştur</h2>
                    <div class="mb-4">
                        <label for="registerEmail" class="block text-gray-400 mb-2">E-posta</label>
                        <input type="email" id="registerEmail" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="registerPassword" class="block text-gray-400 mb-2">Şifre</label>
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Hesap Oluştur</button>
                    <p class="text-center text-gray-400 mt-6">
                        Zaten hesabın var mı? <a href="#" id="showLogin" class="text-cyan-400 hover:underline">Giriş Yap</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="appContainer" class="container mx-auto p-4 md:p-8 max-w-4xl mb-24 hidden">
        <header class="text-center mb-8">
            <div class="cinema-title-container">
                <h1 id="appTitle" class="text-5xl md:text-6xl cinema-title" data-text="Film Günlüğüm">Film Günlüğüm</h1>
            </div>
            <div class="mt-4 flex justify-center items-center gap-4">
                <div>
                    <p id="userEmailDisplay" class="text-gray-400"></p>
                    <h2 id="userNameDisplay" class="text-2xl text-gray-300 hidden"></h2>
                </div>
                <button id="settingsIconBtn" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Ayarlar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
            <button id="logoutBtn" class="mt-4 text-sm text-red-400 hover:underline">Çıkış Yap</button>
        </header>

        <div class="mb-8 border-b border-gray-700">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="mainTabBtn" class="tab-btn active font-medium px-4 py-2 text-gray-300 rounded-t-lg">Film Günlüğüm</button>
                <button id="watchlistTabBtn" class="tab-btn font-medium px-4 py-2 text-gray-300 rounded-t-lg">İzleme Listem</button>
                <button id="collectionTabBtn" class="tab-btn font-medium px-4 py-2 text-gray-300 rounded-t-lg">Koleksiyonum</button>
                <button id="analysisTabBtn" class="tab-btn font-medium px-4 py-2 text-gray-300 rounded-t-lg">Analiz</button>
            </nav>
        </div>

        <main>
            <div id="mainContent">
                <div class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Yeni Film Ekle</h2>
                    <form id="searchForm" class="flex flex-col sm:flex-row gap-4">
                        <div class="relative w-full">
                            <input type="text" id="searchInput" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 text-white pr-10" placeholder="Film, yönetmen veya oyuncu ara..." required>
                            <button type="button" id="clearSearchInput" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-white hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <button type="submit" class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg">Ara</button>
                    </form>
                </div>
                <div id="searchResultsWrapper" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-white">Arama Sonuçları</h3>
                        <button id="closeSearchResultsBtn" class="p-2 rounded-full hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div id="searchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8"></div>
                    <div id="paginationControls" class="flex justify-center items-center gap-4 mt-8"></div>
                </div>
                <div id="search-loader" class="text-center hidden"><p>Aranıyor...</p></div>
                <div>
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 border-b-2 border-gray-700 pb-4 mt-8">
                        <div class="flex items-center gap-3">
                            <h2 class="text-3xl font-bold text-white">İzlediklerim</h2>
                            <span id="watchedCount" class="bg-cyan-600 text-white text-sm font-bold px-2.5 py-1 rounded-full">0</span>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <div class="relative w-full md:w-2/3">
                            <input type="text" id="filterInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 pr-10" placeholder="Listemde başlık, yönetmen veya oyuncu ara...">
                            <button type="button" id="clearFilterInput" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-white hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <select id="genreFilter" class="w-full md:w-1/3 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="">Tüm Türler</option>
                        </select>
                    </div>
                    <div id="watchedList" class="space-y-6"></div>
                    <div id="list-loader" class="text-center mt-8"><p>Listeniz yükleniyor...</p></div>
                    <p id="no-filter-results" class="text-center hidden mt-6">Arama kriterlerinize uygun film bulunamadı.</p>
                </div>
            </div>

            <div id="watchlistContent" class="hidden">
                <div class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">İzleme Listesine Film Ekle</h2>
                    <form id="watchlistSearchForm" class="flex flex-col sm:flex-row gap-4">
                        <div class="relative w-full">
                            <input type="text" id="watchlistSearchInput" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 text-white pr-10" placeholder="Film ara..." required>
                            <button type="button" id="clearWatchlistSearchInput" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-white hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <button type="submit" class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg">Ara</button>
                    </form>
                </div>
                 <div id="watchlistSearchResultsWrapper" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-white">Arama Sonuçları</h3>
                        <button id="closeWatchlistSearchResultsBtn" class="p-2 rounded-full hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div id="watchlistSearchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8"></div>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-white mb-4">İzleme Listem (<span id="watchlistCount">0</span>)</h2>
                    <div id="watchlistContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    <div id="watchlist-loader" class="text-center mt-8 hidden"><p>İzleme listeniz yükleniyor...</p></div>
                </div>
            </div>

            <div id="collectionContent" class="hidden">
                <div class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Koleksiyona DVD Ekle</h2>
                    <form id="dvdSearchForm" class="flex flex-col sm:flex-row gap-4">
                         <div class="relative w-full">
                            <input type="text" id="dvdSearchInput" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 pr-10" placeholder="Koleksiyon için film ara..." required>
                            <button type="button" id="clearDvdSearchInput" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-white hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <button type="submit" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">Ara</button>
                    </form>
                </div>
                <div id="dvdSearchResultsWrapper" class="hidden">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-white">Arama Sonuçları</h3>
                        <button id="closeDvdSearchResultsBtn" class="p-2 rounded-full hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div id="dvdSearchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8"></div>
                </div>
                <div id="dvd-search-loader" class="text-center hidden"><p>Aranıyor...</p></div>
                <div>
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 border-b-2 border-gray-700 pb-4 mt-8">
                        <h2 class="text-3xl font-bold text-white">DVD Koleksiyonum (<span id="dvdCount">0</span>)</h2>
                        <div class="relative w-full md:w-1/3">
                           <input type="text" id="dvdFilterInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 pr-10" placeholder="Koleksiyonda ara...">
                            <button type="button" id="clearDvdFilterInput" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-white hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div id="dvdListContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    </div>
                    <div id="dvd-list-loader" class="text-center mt-8 hidden"><p>Koleksiyon yükleniyor...</p></div>
                </div>
            </div>

            <div id="analysisContent" class="hidden">
                <h2 class="text-3xl font-bold text-white mb-6 border-b-2 border-gray-700 pb-4">İzleme Analizi</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-2xl font-semibold mb-4 text-cyan-400">Favori Yönetmenler</h3>
                        <ul id="directorAnalysis" class="space-y-2 text-gray-300"></ul>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold mb-4 text-cyan-400">Favori Oyuncular</h3>
                        <ul id="actorAnalysis" class="space-y-2 text-gray-300"></ul>
                    </div>
                </div>
            </div>

            <div id="settingsContent" class="hidden">
                <div id="settingsSection" class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Kullanıcı Bilgileri</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="firstNameInput" placeholder="Adınız" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="lastNameInput" placeholder="Soyadınız" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="saveSettingsBtn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Bilgileri Kaydet</button>
                </div>
                <div id="bulkAddSection" class="mb-8 p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Toplu Film Ekle</h2>
                    <p class="text-gray-400 mb-4">Google Keep veya başka bir yerden kopyaladığınız film listenizi (her film yeni bir satırda olacak şekilde) aşağıdaki alana yapıştırın.</p>
                    <textarea id="bulkAddTextarea" class="w-full h-48 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Inception&#10;The Matrix - Yönetmen: Wachowskis&#10;Parasite..."></textarea>
                    <button id="bulkAddBtn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg">Listeyi İçe Aktar</button>
                    <div id="bulkAddStatus" class="mt-4 text-sm text-gray-400"></div>
                </div>
                <div id="dataManagementSection" class="p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Veri Yönetimi</h2>
                    <button id="updateAllBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg mb-4">Tüm Film Bilgilerini Güncelle</button>
                    <div id="updateAllStatus" class="text-center text-sm text-gray-400 mb-4"></div>
                    <button id="exportBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg">Listeyi Dışa Aktar (CSV)</button>
                </div>
            </div>
        </main>
    </div>

    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"><p id="notification-message"></p></div>
    
    <button id="backToTopBtn" class="fixed bottom-5 right-5 bg-cyan-600 hover:bg-cyan-700 text-white p-3 rounded-full shadow-lg opacity-0 transform translate-y-16 transition-all duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    
    <div id="confirmModal" class="fixed inset-0 w-full h-full bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
            <h3 id="confirmModalTitle" class="text-xl font-semibold mb-4">Emin misiniz?</h3>
            <p id="confirmModalMessage" class="text-gray-300 mb-6">Bu işlemi yapmak istediğinizden emin misiniz?</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">İptal</button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Onayla</button>
            </div>
        </div>
    </div>
    
    <div id="movieInfoModal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div id="movieInfoModalContent" class="bg-gray-800 max-w-3xl w-full max-h-[90vh] overflow-y-auto rounded-xl shadow-lg relative">
            <!-- Content will be injected by JS -->
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, setLogLevel, getDoc, setDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION ---
        const TMDB_API_KEY = 'be3431f83282ebf814b6db565e75105d';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        
        // --- GLOBAL VARIABLES & STATE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEgd5WVdDQxFFDUkTw7Kt1qqDbWQdmBo8",
            authDomain: "filmgunlugum-81fba.firebaseapp.com",
            projectId: "filmgunlugum-81fba",
            storageBucket: "filmgunlugum-81fba.appspot.com",
            messagingSenderId: "75259418247",
            appId: "1:75259418247:web:6bf046a8f913ebd1be4a22",
            measurementId: "G-4ZXXQ124RH"
        };

        const appId = firebaseConfig.projectId;
        
        let app, auth, db, userId;
        let watchedMoviesList = [];
        let dvdCollectionList = [];
        let watchlistMovies = [];
        let unsubscribeSettings = () => {};
        let unsubscribeMovies = () => {};
        let unsubscribeDvds = () => {};
        let unsubscribeWatchlist = () => {};
        let lastSearchQuery = '';
        let deleteAction = null;

        // Enable Firestore logging for debugging
        setLogLevel('debug');

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const loadingOverlay = document.getElementById('loadingOverlay');
            const authContainer = document.getElementById('authContainer');
            const appContainer = document.getElementById('appContainer');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const showRegister = document.getElementById('showRegister');
            const showLogin = document.getElementById('showLogin');
            const logoutBtn = document.getElementById('logoutBtn');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const mainTabBtn = document.getElementById('mainTabBtn');
            const collectionTabBtn = document.getElementById('collectionTabBtn');
            const analysisTabBtn = document.getElementById('analysisTabBtn');
            const settingsIconBtn = document.getElementById('settingsIconBtn');
            const watchlistTabBtn = document.getElementById('watchlistTabBtn');
            const mainContent = document.getElementById('mainContent');
            const collectionContent = document.getElementById('collectionContent');
            const analysisContent = document.getElementById('analysisContent');
            const settingsContent = document.getElementById('settingsContent');
            const watchlistContent = document.getElementById('watchlistContent');
            const firstNameInput = document.getElementById('firstNameInput');
            const lastNameInput = document.getElementById('lastNameInput');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const clearSearchInput = document.getElementById('clearSearchInput');
            const searchResultsWrapper = document.getElementById('searchResultsWrapper');
            const searchResultsContainer = document.getElementById('searchResults');
            const closeSearchResultsBtn = document.getElementById('closeSearchResultsBtn');
            const watchedListContainer = document.getElementById('watchedList');
            const filterInput = document.getElementById('filterInput');
            const clearFilterInput = document.getElementById('clearFilterInput');
            const genreFilter = document.getElementById('genreFilter');
            const noFilterResults = document.getElementById('no-filter-results');
            const watchedCount = document.getElementById('watchedCount');
            const dvdSearchForm = document.getElementById('dvdSearchForm');
            const dvdSearchInput = document.getElementById('dvdSearchInput');
            const clearDvdSearchInput = document.getElementById('clearDvdSearchInput');
            const dvdSearchResultsWrapper = document.getElementById('dvdSearchResultsWrapper');
            const dvdSearchResultsContainer = document.getElementById('dvdSearchResults');
            const closeDvdSearchResultsBtn = document.getElementById('closeDvdSearchResultsBtn');
            const dvdListContainer = document.getElementById('dvdListContainer');
            const dvdCount = document.getElementById('dvdCount');
            const dvdFilterInput = document.getElementById('dvdFilterInput');
            const clearDvdFilterInput = document.getElementById('clearDvdFilterInput');
            const watchlistSearchForm = document.getElementById('watchlistSearchForm');
            const watchlistSearchInput = document.getElementById('watchlistSearchInput');
            const clearWatchlistSearchInput = document.getElementById('clearWatchlistSearchInput');
            const watchlistSearchResultsWrapper = document.getElementById('watchlistSearchResultsWrapper');
            const watchlistSearchResultsContainer = document.getElementById('watchlistSearchResults');
            const closeWatchlistSearchResultsBtn = document.getElementById('closeWatchlistSearchResultsBtn');
            const watchlistContainer = document.getElementById('watchlistContainer');
            const watchlistCount = document.getElementById('watchlistCount');
            const exportBtn = document.getElementById('exportBtn');
            const bulkAddBtn = document.getElementById('bulkAddBtn');
            const bulkAddTextarea = document.getElementById('bulkAddTextarea');
            const bulkAddStatus = document.getElementById('bulkAddStatus');
            const updateAllBtn = document.getElementById('updateAllBtn');
            const updateAllStatus = document.getElementById('updateAllStatus');
            const backToTopBtn = document.getElementById('backToTopBtn');
            const paginationControls = document.getElementById('paginationControls');
            const confirmModal = document.getElementById('confirmModal');
            const confirmModalMessage = document.getElementById('confirmModalMessage');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const movieInfoModal = document.getElementById('movieInfoModal');
            const movieInfoModalContent = document.getElementById('movieInfoModalContent');
            const directorAnalysisList = document.getElementById('directorAnalysis');
            const actorAnalysisList = document.getElementById('actorAnalysis');

            // --- APP INITIALIZATION ---
            (async () => {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    await setPersistence(auth, browserLocalPersistence);

                    onAuthStateChanged(auth, (user) => {
                        cleanupListeners();
                        if (user) {
                            userId = user.uid;
                            authContainer.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            userEmailDisplay.textContent = `Giriş yapıldı: ${user.email}`;
                            setupListeners();
                        } else {
                            userId = null;
                            authContainer.classList.remove('hidden');
                            appContainer.classList.add('hidden');
                            watchedListContainer.innerHTML = '';
                            dvdListContainer.innerHTML = '';
                            watchlistContainer.innerHTML = '';
                        }
                        loadingOverlay.classList.add('hidden');
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    loadingOverlay.classList.add('hidden');
                    showNotification("Uygulama başlatılamadı. Lütfen tekrar deneyin.", true);
                }
            })();


            // --- AUTHENTICATION LOGIC ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = loginForm.loginEmail.value;
                const password = loginForm.loginPassword.value;
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => showNotification(getAuthErrorMessage(error.code), true));
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = registerForm.registerEmail.value;
                const password = registerForm.registerPassword.value;
                createUserWithEmailAndPassword(auth, email, password)
                    .catch(error => showNotification(getAuthErrorMessage(error.code), true));
            });

            logoutBtn.addEventListener('click', () => {
                signOut(auth);
            });

            showRegister.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginFormContainer').classList.add('hidden');
                document.getElementById('registerFormContainer').classList.remove('hidden');
            });

            showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginFormContainer').classList.remove('hidden');
                document.getElementById('registerFormContainer').classList.add('hidden');
            });
            
            // --- DATA LISTENERS ---
            function cleanupListeners() {
                if (typeof unsubscribeSettings === 'function') unsubscribeSettings();
                if (typeof unsubscribeMovies === 'function') unsubscribeMovies();
                if (typeof unsubscribeDvds === 'function') unsubscribeDvds();
                if (typeof unsubscribeWatchlist === 'function') unsubscribeWatchlist();
            }
            
            function setupListeners() {
                if (!userId) return;

                // User Settings Listener
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'profile');
                unsubscribeSettings = onSnapshot(settingsDocRef, (docSnap) => {
                    const settings = docSnap.exists() ? docSnap.data() : {};
                    if (document.activeElement !== firstNameInput) firstNameInput.value = settings.firstName || '';
                    if (document.activeElement !== lastNameInput) lastNameInput.value = settings.lastName || '';
                    const fullName = [settings.firstName, settings.lastName].filter(Boolean).join(' ');
                    userNameDisplay.textContent = fullName;
                    userNameDisplay.classList.toggle('hidden', !fullName);
                });
                
                // Watched Movies Listener
                const listLoader = document.getElementById('list-loader');
                listLoader.classList.remove('hidden');
                const moviesCollectionPath = collection(db, 'artifacts', appId, 'users', userId, 'movies');
                unsubscribeMovies = onSnapshot(query(moviesCollectionPath), (snapshot) => {
                    listLoader.classList.add('hidden');
                    watchedMoviesList = [];
                    snapshot.forEach(doc => watchedMoviesList.push({ id: doc.id, ...doc.data() }));
                    watchedMoviesList.sort((a, b) => a.title.localeCompare(b.title, 'tr'));
                    watchedCount.textContent = watchedMoviesList.length;
                    populateGenreFilter();
                    filterAndDisplayWatchedMovies();
                    generateAnalysis();
                    if(snapshot.empty) { watchedListContainer.innerHTML = `<div class="text-center py-10 px-6 bg-gray-800 rounded-lg"><p>Henüz izlediğiniz bir film eklemediniz.</p></div>`; }
                }, (error) => { console.error("Error listening to movie collection:", error); });

                // DVD Collection Listener
                const dvdListLoader = document.getElementById('dvd-list-loader');
                dvdListLoader.classList.remove('hidden');
                const dvdCollectionPath = collection(db, 'artifacts', appId, 'users', userId, 'dvd_collection');
                unsubscribeDvds = onSnapshot(query(dvdCollectionPath), (snapshot) => {
                    dvdListLoader.classList.add('hidden');
                    dvdCollectionList = [];
                    snapshot.forEach(doc => dvdCollectionList.push({ id: doc.id, ...doc.data() }));
                    dvdCount.textContent = dvdCollectionList.length;
                    filterAndDisplayDvds();
                    if(snapshot.empty) { dvdListContainer.innerHTML = `<p class="col-span-full text-center text-gray-400">Henüz koleksiyonunuza bir DVD eklemediniz.</p>`; }
                });

                // Watchlist Listener
                const watchlistLoader = document.getElementById('watchlist-loader');
                watchlistLoader.classList.remove('hidden');
                const watchlistCollectionPath = collection(db, 'artifacts', appId, 'users', userId, 'watchlist');
                unsubscribeWatchlist = onSnapshot(query(watchlistCollectionPath), (snapshot) => {
                    watchlistLoader.classList.add('hidden');
                    watchlistMovies = [];
                    snapshot.forEach(doc => watchlistMovies.push({ id: doc.id, ...doc.data() }));
                    watchlistCount.textContent = watchlistMovies.length;
                    displayWatchlist();
                    if(snapshot.empty) { watchlistContainer.innerHTML = `<p class="col-span-full text-center text-gray-400">İzleme listeniz boş.</p>`; }
                }, (error) => { console.error("Error listening to watchlist collection:", error); });
            }


            // --- TAB NAVIGATION LOGIC ---
            function showTab(contentToShow, buttonToActivate) {
                [mainContent, collectionContent, analysisContent, settingsContent, watchlistContent].forEach(el => el.classList.add('hidden'));
                [mainTabBtn, collectionTabBtn, analysisTabBtn, watchlistTabBtn, settingsIconBtn].forEach(el => el.classList.remove('active'));
                
                contentToShow.classList.remove('hidden');
                buttonToActivate.classList.add('active');
            }
            
            mainTabBtn.addEventListener('click', () => showTab(mainContent, mainTabBtn));
            collectionTabBtn.addEventListener('click', () => showTab(collectionContent, collectionTabBtn));
            analysisTabBtn.addEventListener('click', () => showTab(analysisContent, analysisTabBtn));
            watchlistTabBtn.addEventListener('click', () => showTab(watchlistContent, watchlistTabBtn));
            settingsIconBtn.addEventListener('click', () => showTab(settingsContent, settingsIconBtn));


            // --- USER SETTINGS FUNCTIONS ---
            async function saveUserSettings() {
                if (!userId) return;
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'profile');
                const settingsData = { firstName: firstNameInput.value.trim(), lastName: lastNameInput.value.trim() };
                try {
                    await setDoc(settingsDocRef, settingsData, { merge: true });
                    showNotification("Kullanıcı bilgileri kaydedildi!", false);
                } catch (error) {
                    showNotification("Ayarlar kaydedilirken hata oluştu.", true);
                }
            }
            
            // --- TMDB API & FIRESTORE FUNCTIONS ---
            async function performMultiSearch(query, page = 1) {
                if (!TMDB_API_KEY) { showNotification("TMDb API anahtarı eksik.", true); return null; }
                const searchLoader = document.getElementById('search-loader');
                searchResultsContainer.innerHTML = '';
                paginationControls.innerHTML = '';
                searchLoader.classList.remove('hidden');
                const url = `${TMDB_BASE_URL}/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&language=tr-TR&include_adult=false&page=${page}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) return null;
                    return await response.json();
                } catch (error) { console.error('Error fetching multi-search:', error); return null; } 
                finally { searchLoader.classList.add('hidden'); }
            }

            function displayMultiSearchResults(data) {
                const results = data.results;
                searchResultsContainer.innerHTML = '';
                if (!results || results.length === 0) {
                    searchResultsContainer.innerHTML = `<p class="col-span-full text-center">Sonuç bulunamadı.</p>`;
                    return;
                }
                searchResultsWrapper.classList.remove('hidden');
                results.forEach(result => {
                    if (result.media_type === 'movie') {
                        const posterPath = result.poster_path ? `https://image.tmdb.org/t/p/w500${result.poster_path}` : 'https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';
                        const releaseYear = result.release_date ? result.release_date.split('-')[0] : 'N/A';
                        const movieCard = `<div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg movie-card flex flex-col"><div class="w-full h-48 bg-gray-700 flex items-center justify-center"><img src="${posterPath}" alt="${result.title}" class="w-full h-full object-contain" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';"></div><div class="p-3 flex flex-col flex-grow"><h3 class="font-bold text-sm text-white">${result.title}</h3><p class="text-gray-400 text-xs mb-2">${releaseYear}</p><button class="add-movie-btn mt-auto w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-2 text-sm rounded-lg" data-tmdb-id="${result.id}" data-title="${encodeURIComponent(result.title)}" data-poster-path="${result.poster_path || ''}" data-release-year="${releaseYear}">İzlediklerime Ekle</button></div></div>`;
                        searchResultsContainer.innerHTML += movieCard;
                    } else if (result.media_type === 'person') {
                        const profilePath = result.profile_path ? `https://image.tmdb.org/t/p/w500${result.profile_path}` : 'https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';
                        const personCard = `<div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg movie-card flex flex-col"><div class="w-full h-48 bg-gray-700 flex items-center justify-center"><img src="${profilePath}" alt="${result.name}" class="w-full h-full object-contain" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/500x750/1f2937/4b5563?text=Poster+Yok';"></div><div class="p-3 flex flex-col flex-grow"><h3 class="font-bold text-sm text-white">${result.name}</h3><p class="text-gray-400 text-xs mb-2">${result.known_for_department}</p><button class="show-person-movies-btn mt-auto w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1 px-2 text-sm rounded-lg" data-person-id="${result.id}">Filmlerini Göster</button></div></div>`;
                        searchResultsContainer.innerHTML += personCard;
                    }
                });
                renderPaginationControls(data.page, data.total_pages);
            }
            
            async function getPersonMovieCredits(personId) {
                if (!TMDB_API_KEY) return null;
                const url = `${TMDB_BASE_URL}/person/${personId}/movie_credits?api_key=${TMDB_API_KEY}&language=tr-TR`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) return null;
                    const data = await response.json();
                    const allMovies = [...data.cast, ...data.crew].map(m => ({ ...m, media_type: 'movie' }));
                    const uniqueMovies = Array.from(new Map(allMovies.map(movie => [movie.id, movie])).values());
                    return uniqueMovies.sort((a, b) => b.popularity - a.popularity);
                } catch (error) {
                    console.error('Error fetching person credits:', error);
                    return null;
                }
            }
            
            async function getMovieDetails(tmdbId) {
                if (!TMDB_API_KEY) return null;
                const url = `${TMDB_BASE_URL}/movie/${tmdbId}?api_key=${TMDB_API_KEY}&language=tr-TR&append_to_response=watch/providers,credits`;
                try { const response = await fetch(url); return await response.json(); } catch (error) { return null
